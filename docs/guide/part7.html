<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Part 7: Skills & Hooks - Claude Code Guide</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body>
  <nav class="nav">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">Claude Code Guide</a>
      <button class="nav-toggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="part1.html">Security</a></li>
        <li><a href="part2.html">Scaffolding</a></li>
        <li><a href="part3.html">MCP</a></li>
        <li><a href="part4.html">Context7</a></li>
        <li><a href="part5.html">Commands</a></li>
        <li><a href="part6.html">Chats</a></li>
        <li><a href="part7.html">Hooks</a></li>
        <li><a href="reference.html">Reference</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <h1>Part 7: Skills & Hooks — Enforcement Over Suggestion</h1>

    <p>This section was added based on community feedback. Special thanks to u/headset38 and u/tulensrma for pointing out that <strong>Claude doesn't always follow CLAUDE.md rules rigorously</strong>.</p>

    <h2>Why CLAUDE.md Rules Can Fail</h2>

    <p><a href="https://paddo.dev/blog/claude-code-hooks-guardrails/">Research on prompt-based guardrails</a> explains:</p>

    <blockquote>
      <p>"Prompts are interpreted at runtime by an LLM that can be convinced otherwise. You need something deterministic."</p>
    </blockquote>

    <p>Common failure modes:</p>
    <ul>
      <li><strong>Context window pressure</strong>: Long conversations can push rules out of active attention</li>
      <li><strong>Conflicting instructions</strong>: Other context may override your rules</li>
      <li><strong>Copy-paste propagation</strong>: Even if Claude won't edit <code>.env</code>, it might copy secrets to another file</li>
    </ul>

    <p>One community member noted their PreToolUse hook catches Claude attempting to access <code>.env</code> files "a few times per week" — despite explicit CLAUDE.md rules saying not to.</p>

    <h2>The Critical Difference</h2>

    <table>
      <thead>
        <tr>
          <th>Mechanism</th>
          <th>Type</th>
          <th>Reliability</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>CLAUDE.md rules</td>
          <td>Suggestion</td>
          <td>Good, but can be overridden</td>
        </tr>
        <tr>
          <td><strong>Hooks</strong></td>
          <td><strong>Enforcement</strong></td>
          <td><strong>Deterministic — always runs</strong></td>
        </tr>
        <tr>
          <td>settings.json deny list</td>
          <td>Enforcement</td>
          <td>Good</td>
        </tr>
        <tr>
          <td>.gitignore</td>
          <td>Last resort</td>
          <td>Only prevents commits</td>
        </tr>
      </tbody>
    </table>

    <pre><code>PreToolUse hook blocking .env edits:
  → Always runs
  → Returns exit code 2
  → Operation blocked. Period.

CLAUDE.md saying "don't edit .env":
  → Parsed by LLM
  → Weighed against other context
  → Maybe followed</code></pre>

    <h2>Hooks: Deterministic Control</h2>

    <p><a href="https://code.claude.com/docs/en/hooks">Hooks</a> are shell commands that execute at specific lifecycle points. They're not suggestions — they're code that runs every time.</p>

    <h3>Hook Events</h3>

    <table>
      <thead>
        <tr>
          <th>Event</th>
          <th>When It Fires</th>
          <th>Use Case</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>PreToolUse</code></td>
          <td>Before any tool executes</td>
          <td>Block dangerous operations</td>
        </tr>
        <tr>
          <td><code>PostToolUse</code></td>
          <td>After tool completes</td>
          <td>Run linters, formatters, tests</td>
        </tr>
        <tr>
          <td><code>Stop</code></td>
          <td>When Claude finishes responding</td>
          <td>End-of-turn quality gates</td>
        </tr>
        <tr>
          <td><code>UserPromptSubmit</code></td>
          <td>When user submits prompt</td>
          <td>Validate/enhance prompts</td>
        </tr>
        <tr>
          <td><code>SessionStart</code></td>
          <td>New session begins</td>
          <td>Load context, initialize</td>
        </tr>
        <tr>
          <td><code>Notification</code></td>
          <td>Claude sends alerts</td>
          <td>Desktop notifications</td>
        </tr>
      </tbody>
    </table>

    <h3>Example: Block Secrets Access</h3>

    <p>Add to <code>~/.claude/settings.json</code>:</p>

    <pre><code class="language-json">{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Read|Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "python3 ~/.claude/hooks/block-secrets.py"
          }
        ]
      }
    ]
  }
}</code></pre>

    <p>The hook script (<code>~/.claude/hooks/block-secrets.py</code>):</p>

    <pre><code class="language-python">#!/usr/bin/env python3
"""
PreToolUse hook to block access to sensitive files.
Exit code 2 = block operation and feed stderr to Claude.
"""
import json
import sys
from pathlib import Path

SENSITIVE_PATTERNS = {
    '.env', '.env.local', '.env.production',
    'secrets.json', 'secrets.yaml',
    'id_rsa', 'id_ed25519', '.npmrc', '.pypirc'
}

def main():
    try:
        data = json.load(sys.stdin)
        tool_input = data.get('tool_input', {})
        file_path = tool_input.get('file_path') or tool_input.get('path') or ''

        if not file_path:
            sys.exit(0)

        path = Path(file_path)

        if path.name in SENSITIVE_PATTERNS or '.env' in str(path):
            print(f"BLOCKED: Access to '{path.name}' denied.", file=sys.stderr)
            print("Use environment variables instead.", file=sys.stderr)
            sys.exit(2)  # Exit 2 = block and feed stderr to Claude

        sys.exit(0)
    except Exception:
        sys.exit(0)  # Fail open

if __name__ == '__main__':
    main()</code></pre>

    <h3>Example: Quality Gates on Stop</h3>

    <p>Run linters and tests when Claude finishes each turn:</p>

    <pre><code class="language-json">{
  "hooks": {
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/hooks/end-of-turn.sh"
          }
        ]
      }
    ]
  }
}</code></pre>

    <h3>Hook Exit Codes</h3>

    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Meaning</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>0</td>
          <td>Success, allow operation</td>
        </tr>
        <tr>
          <td>1</td>
          <td>Error (shown to user only)</td>
        </tr>
        <tr>
          <td><strong>2</strong></td>
          <td><strong>Block operation, feed stderr to Claude</strong></td>
        </tr>
      </tbody>
    </table>

    <h3>Hook Input Format</h3>

    <p>Hooks receive JSON via stdin containing context about the current operation.</p>

    <p><strong>PreToolUse / PostToolUse:</strong></p>

    <pre><code class="language-json">{
  "hook_type": "PreToolUse",
  "tool_name": "Read",
  "tool_input": {
    "file_path": "/path/to/file.js"
  },
  "session_id": "abc123-def456"
}</code></pre>

    <p><strong>Stop (end of turn):</strong></p>

    <pre><code class="language-json">{
  "hook_type": "Stop",
  "stop_reason": "end_turn",
  "transcript_path": "/tmp/claude/transcript.json"
}</code></pre>

    <p><strong>UserPromptSubmit:</strong></p>

    <pre><code class="language-json">{
  "hook_type": "UserPromptSubmit",
  "prompt": "Help me refactor this function",
  "session_id": "abc123-def456"
}</code></pre>

    <h2>Skills: Packaged Expertise</h2>

    <p><a href="https://code.claude.com/docs/en/skills">Skills</a> are markdown files that teach Claude how to do something specific — like a training manual it can reference on demand.</p>

    <p>From <a href="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills">Anthropic's engineering blog</a>:</p>

    <blockquote>
      <p>"Building a skill for an agent is like putting together an onboarding guide for a new hire."</p>
    </blockquote>

    <h3>How Skills Work</h3>

    <p><strong>Progressive disclosure</strong> is the key principle:</p>
    <ol>
      <li><strong>Startup</strong>: Claude loads only skill <em>names and descriptions</em> into context</li>
      <li><strong>Triggered</strong>: When relevant, Claude reads the full <code>SKILL.md</code> file</li>
      <li><strong>As needed</strong>: Additional resources load only when referenced</li>
    </ol>

    <p>This makes skills <strong>extremely token efficient</strong>. A 500-line skill costs zero tokens until triggered. Compare this to putting the same instructions in CLAUDE.md, where they consume context in every single conversation — even when irrelevant.</p>

    <p><strong>Rule of thumb:</strong> If instructions apply to &lt;20% of your conversations, make it a skill instead of adding it to CLAUDE.md.</p>

    <h3>Skill Structure</h3>

    <pre><code>.claude/skills/
└── commit-messages/
    ├── SKILL.md           ← Required: instructions + frontmatter
    ├── templates.md       ← Optional: reference material
    └── validate.py        ← Optional: executable scripts</code></pre>

    <p><strong>SKILL.md</strong> (required):</p>

    <pre><code class="language-markdown">---
name: commit-messages
description: Generate clear commit messages from git diffs. Use when writing commit messages or reviewing staged changes.
---

# Commit Message Skill

When generating commit messages:
1. Run `git diff --staged` to see changes
2. Use conventional commit format: `type(scope): description`
3. Keep subject line under 72 characters

## Types
- feat: New feature
- fix: Bug fix
- docs: Documentation
- refactor: Code restructuring</code></pre>

    <h3>When to Use Skills vs Other Options</h3>

    <table>
      <thead>
        <tr>
          <th>Need</th>
          <th>Solution</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Project-specific instructions</td>
          <td>Project <code>CLAUDE.md</code></td>
        </tr>
        <tr>
          <td>Reusable workflow across projects</td>
          <td><strong>Skill</strong></td>
        </tr>
        <tr>
          <td>External tool integration</td>
          <td>MCP Server</td>
        </tr>
        <tr>
          <td>Deterministic enforcement</td>
          <td><strong>Hook</strong></td>
        </tr>
        <tr>
          <td>One-off automation</td>
          <td>Slash Command</td>
        </tr>
      </tbody>
    </table>

    <h2>Combining Hooks and Skills</h2>

    <p>The most robust setups use both:</p>
    <ul>
      <li>A <code>secrets-handling</code> <strong>skill</strong> teaches Claude <em>how</em> to work with secrets properly</li>
      <li>A <code>PreToolUse</code> <strong>hook</strong> <em>enforces</em> that Claude can never actually read <code>.env</code> files</li>
    </ul>

    <h2>Updated Defense in Depth</h2>

    <table>
      <thead>
        <tr>
          <th>Layer</th>
          <th>Mechanism</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>CLAUDE.md behavioral rules</td>
          <td>Suggestion</td>
        </tr>
        <tr>
          <td><strong>2</strong></td>
          <td><strong>PreToolUse hooks</strong></td>
          <td><strong>Enforcement</strong></td>
        </tr>
        <tr>
          <td>3</td>
          <td>settings.json deny list</td>
          <td>Enforcement</td>
        </tr>
        <tr>
          <td>4</td>
          <td>.gitignore</td>
          <td>Prevention</td>
        </tr>
        <tr>
          <td><strong>5</strong></td>
          <td><strong>Skills with security checklists</strong></td>
          <td><strong>Guidance</strong></td>
        </tr>
      </tbody>
    </table>

    <div class="page-nav">
      <a href="part6.html" class="prev">Part 6: Single-Purpose Chats</a>
      <a href="reference.html" class="next">Quick Reference</a>
    </div>
  </main>

  <footer class="footer">
    <p>Based on the guide by TheDecipherist • <a href="https://github.com/TheDecipherist/claude-code-mastery">GitHub Repository</a></p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="script.js"></script>
</body>
</html>
